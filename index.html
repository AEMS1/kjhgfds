<!DOCTYPE html>
<html>
<head>
  <title>Mini PancakeSwap</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h1>Mini PancakeSwap - BNB ↔ BUSD</h1>

  <button onclick="connectWallet()">🔗 اتصال به MetaMask</button>

  <div>
    <p>مقدار BNB:</p>
    <input type="text" id="bnbAmount" placeholder="مثلاً 0.01">
  </div>

  <button onclick="swapBNBtoBUSD()">🔄 سواپ BNB به BUSD</button>

  <p id="status"></p>

  <script>
    const routerAddress = "0x10ED43C718714eb63d5aA57B78B54704E256024E"; // PancakeSwap Router V2
    const BUSD_ADDRESS = "0xe9e7cea3dedca5984780bafc599bd69add087d56"; // BUSD Token (BEP-20)

    const routerAbi = [
      "function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) payable returns (uint[] memory amounts)"
    ];

    let provider, signer;

    async function connectWallet() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const address = await signer.getAddress();
        document.getElementById("status").innerText = "✅ کیف پول متصل شد: " + address;
      } else {
        alert("MetaMask نصب نیست.");
      }
    }

    async function swapBNBtoBUSD() {
      const amountInput = document.getElementById("bnbAmount").value;
      if (!amountInput) return alert("لطفاً مقدار BNB وارد کن");

      const router = new ethers.Contract(routerAddress, routerAbi, signer);
      const to = await signer.getAddress();
      const amountOutMin = 0; // بدون محدودیت حداقل خروجی
      const path = [
        "0xBB4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c", // WBNB
        BUSD_ADDRESS
      ];
      const deadline = Math.floor(Date.now() / 1000) + 60 * 10; // 10 دقیقه

      try {
        const tx = await router.swapExactETHForTokens(
          amountOutMin,
          path,
          to,
          deadline,
          { value: ethers.utils.parseEther(amountInput) }
        );

        document.getElementById("status").innerText = "⏳ در حال انجام معامله... TX: " + tx.hash;
        await tx.wait();
        document.getElementById("status").innerText = "✅ معامله انجام شد! TX: " + tx.hash;
      } catch (err) {
        document.getElementById("status").innerText = "❌ خطا: " + err.message;
      }
    }
  </script>
</body>
</html>
